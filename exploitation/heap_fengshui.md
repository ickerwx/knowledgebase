# Heap FengShui

## Off by One exploitation

### Requirements:

Off by one vulnerability that allows to write 1 byte into the following chunks size+status_flags field (often found in malloc followed by strcpy) and the ability to create and free chunks.

### Setup:

Create 4 adjacent chunks, A (0xf8), B (0x68), C (0xf8), D(0x10) and fill them with their size by their letter.

D will just be a buffer chunk to avoid consolidation with the top of the heap and will not be involved in the exploitation.

### Creating overlapping chunks

The goal is to free a big chunk that encapsulates A+B+C while B is still allocated.

* free chunk A
* overflow 1 byte of chunk B into size+status of chunk C, this means that "previous chunk in use" (refering to B) is now false
* set previous_size field of chunk C to the size of A + B (0x170) combined
* free chunk C

Now A+B+C get consolidated into one large free chunk because previous_size of chunk C was faked and B was marked as not in use.

When allocating a new buffer (0x100) in this chunk its FD and BK pointers (libc addresses) are pushed down into the still allocated chunk B and could eventually be printed out. This happens because these Pointers are always at the top of a free chunk - which is now directly adjacent to the new buffer.


### Arbitrary Memory Read/Write

The idea is to get a attacker controlled address into a bin/fastbin, then allocate a chunk which fits the size of this bin/fastbin. The chunk will be at the desired address and can be read from or written to.

To get a attacker controller into a bin/fastbin we have to overwrite the FD of a free chunk, effectivly adding an element to the linked list (but at the same time corrupting it).


### Controlling the Program Counter

In order to control the PC we have to do start with the same steps as for arbitrary memory write.

The address of the chunk we fake is `__malloc_hook` which is conviently prefixed with 0x7f which is just inside the fastbin category for a chunk. We can write an abritray address into the field pointed by `__malloc_hook` which will get called whenever malloc is called and thereforce take control of PC.


### Blind leaking of libc addresses

Its also possible to bypass aslr by setting FD to a libcaddress (remember that free generates adresses of main arena and puts them on the heap) and then overwriting some bits of it to make it point to a nearby location.

A problem with this is that we cant set a completly arbitrary address because libc will check that the destination is a valid chunk, by looking if a size+flags header is present.


## Links

* https://devel0pment.de/?p=688


tags: #heap #exploitation #fengshui 
