# The ARM Exploit Lab Training

## To read
- "ROP on ARM", Tim Kornau 
- [Inside Out Attacks, Saumil Shah](http://index-of.co.uk/Tmp/1792.0.inout.pdf)

## Notes Day 1
- four byte aligned memory (ARM mode)/ two byte in THUMB mode
- R7: syscall value, R13: SP, R14: LR, R15: PC
- [Alle verfügbaren Infos zu ARM](infocenter.arm.com)
- AAPCS: ARM Arch Procedure Call Standard
- all instructions must be 32 bit wide in ARM mode
  - can't move 32 bit into a register in one instruction, the command would be >32 bit
  - solved by using Literal Pool, then access it using PC-relative addressing
  - `ldr    r0, =0x41414141`
  - = prefix will place it in literal pool
  - keep in mind that PC is always two instructions ahead
- basic stack overflow exploit:
  - look for `mov pc, sp`, `bx sp` or `blx sp`
- `ret` equivalent in ARM is `bx lr` or `pop {rX..., pc}`
- run `objdump` in ARM and in THUMB mode, forcing  complete disassembly
- functions calling no other functions are called leaf functions
- DOES NOT WORK :( to build a thumb-only binary use `-mthumb` with `as` or `ld` (which one it is needs to be looked up)
- what we did:
  - most of the day was an intro to ARM
  - explore instructions in gdb
  - write a simple shellcode

## Notes Day 2
- sp points to offset 363
- pc is at offset 343
- offset to `bx sp` in libc at 5530
### reverse shell
- sockaddr_in needs to be big-endian!

- what we did:
  - finish plain shellcode from day 1
  - write reverse shell shellcode
  - basic ret2libc inside a webserver xhttpd
  - intro to ropper
    - search for rop gadgets in libc
  - rewrite ret2system so that we use the rop gadgets instead of relying on register content
```
attackbox:~/rop$ ropper
(ropper)> file libc-2.13.so
[INFO] Load gadgets from cache
[LOAD] loading... 100%
[LOAD] removing double gadgets... 100%
[INFO] File loaded.
(libc-2.13.so/ELF/ARM)> search /1/ mov r0, sp
[INFO] Searching for gadgets: mov r0, sp

[INFO] File: libc-2.13.so
0x000ed2c4: mov r0, sp; blx r3; 

(libc-2.13.so/ELF/ARM)> arch ARMTHUMB
[INFO] Load gadgets from cache
[LOAD] loading... 100%
[LOAD] removing double gadgets... 100%
(libc-2.13.so/ELF/ARMTHUMB)> load
[INFO] Load gadgets from cache
[LOAD] loading... 100%
[LOAD] removing double gadgets... 100%
[INFO] gadgets loaded.
(libc-2.13.so/ELF/ARMTHUMB)> 
 
```
### To Do day 2
- find out why `/bin/sh` dies [X]
  - stupid mistake, forgot to start seperate netcat listener m(

## Notes day 3
- xhttpd-nx, stack not executable
- run reverse shell exploit against it, crash, `sp == pc`, `vmmap` or `xinfo $pc` shows that the stack is `rw-`
- goal is to run `mprotect` to make stack executable
- running `xinfo mprotect` while attached to the server process gives
```
gef> xinfo mprotect
------------------------------------[ xinfo: 0xb6f630f0 ]------------------------------------
Found 0xb6f630f0
Page: 0xb6e9c000 -> 0xb6fbe000 (size=0x122000)
Permissions: r-x
Pathname: /lib/arm-linux-gnueabihf/libc-2.13.so
Offset (from page): 0xc70f0
Inode: 4207
Segment: .text (0xb6eb14a0-0xb6f9e35c)
Symbol: mprotect
```
- from `vmmap` we can see that the stack is here:
```
0xbefdf000 0xbf000000 0x00000000 rw- [stack]
```
- `mprotect` has this signature: `int mprotect(void *addr, size_t len, int prot);`
  - `addr` needs to be page-aligned
  - `len` can apparently be any number, but will return an error if not a multiple of `0x1000`. Will work regardless.
  - `prot` *MUST* be 7
- we can calculate all needed values from the gdb output above 

- Saumil has a template to make RPO chains easier. It is on the attackbox VM, user home, `template.pl`
- basic approach: try to control `lr`, optimal would be a `pop {pc}` instruction
  - this way you can safely use leaf gadgets that always return using `bx lr`
- working `mprotect` ROP chain with reverse shell in `~/pi-emu/xhttpd/workingropchain-reverseshell.pl`
### D-Link Router Emulation
- use qemu to run an ARM Ubuntu
- unpack firmware inside qemu, chroot, housekeeping
- shim nvram access

- `cat /proc/cmdline`
- in chroot env you have tp change symbol path for symbols in gdb
  - `set solib-search-path /squashfs-root/lib`
- after setting up the `chroot` env, we started the boot process: `/etc/init.d/rcS`
- attaching to httpd, running PoC
  - crash in `cginbin` which is spawned by httpd

- what we did
  - work on reverse shell
  - implement complete ROP chain to use `mprotect` to make stack executable, then run reverse shell
  - intro to IoT
  - setup emulation for dlink firmware
  - write shellcode for vulnerability
    - mprotect, then reverse shell [X]
    - run telnetd through system() [X]
  - setup emulation for NC-227WF TRIVISION IP CAMERA
    - write ret2libc system() exploit inside the emulator
    - run it against the actual hardware
  - attack a Netgear R6250,
    - do ret2system and mprotect

## Notes Day 4
- do not limit `ropper` usage to `search /1/`!!!
- to defeat ASLR on the D-Link router it was enough to brute-force the offset (`while true; ...`)
- successfully writing ROP chains is basically depending on how fast you can find suitable gadgets
  - you can get lost very fast if you insist on implementing a current way
  - frequently rethink your approach if you hit a problem, chances are you chose an unsuitable way

- what we did
  - finish mprotect ROP chain to make stack executable
  - enable ASLR, run it against web server in qemu
  - run it against the actual device

### To Do day 4
- finish my own ROP chain [X]
  - my own file is `dlink2.pl`, using mostly the same gadgets Saumil used

## useful commands

### in gef
`xinfo $addr`

`vmmap`

```
gef> find /10 0xb6e9c000,0xb6fbe000,0x7
              libc_base  libc_end
```

### in terminal
- searching for instructions
```cheat objdump Disassemble as ARM and ARMTHUMB
objdump -b binary -D -marm libc-2.13.so > objdump-libc-arm.txt
objdump -b binary -D -marm -Mforce-thumb libc-2.13.so > objdump-libc-thumb.txt
```
- copy section from binary and create hex dump
```cheat objdump copy section from binary and create hex dump
objcopy -O binary exec2 exec2.bin
hexdump -v -e '"\\" 1/1 "x%02x"' exec2.bin
```

## improvements
- in second.s, demonstrating the left-shifting in the reverse sub would be better if two different registers would be used
  - as in first do sub x, y, #2 then do rsub x, y, #2 
- set infinite scrollback in the terminals inside the VM, makes checking up old stuff a lot less painful
- add bookmarks to the PDF for quicker navigation

## Notizen für Schulung
- als Einstieg ist der bof victim1 sehr gut geeignet
- return 2 libc demonstrieren
- baue ret2libc als ROP chain
- Aufgabe: reverse shell als ROP chain bauen
  - this is idiot work! ROP chain, um `mprotect` auszuführen

tags: hardware arm training
